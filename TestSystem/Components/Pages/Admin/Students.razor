@page "/admin/students"
@using TestSystem.Entities.Interfaces
@attribute [Authorize(Roles = "Admin")]
@inject IStudentService StudentService

<PageTitle>Students - Admin</PageTitle>

<h3 class="text-primary mb-4">Student Management</h3>

@if (isLoading)
{
    <p class="text-muted">Loading...</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger alert-dismissible fade show">
        @error
        <button type="button" class="btn-close" @onclick="ClearError"></button>
    </div>
}
else
{
    <button class="btn btn-success mb-3" @onclick="StartAdd">
        <i class="bi bi-plus-circle me-2"></i> Add student
    </button>

    @if (isFormVisible)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi @(form.Id == null ? "bi-plus-circle" : "bi-pencil-square") me-2"></i>
                    @(form.Id == null ? "New student" : "Edit student")
                </h5>
            </div>

            <div class="card-body">
                <EditForm Model="form" OnValidSubmit="Save">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger mb-3" />

                    <div class="mb-3">
                        <label class="form-label">First name</label>
                        <InputText class="form-control" @bind-Value="form.FirstName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Last name</label>
                        <InputText class="form-control" @bind-Value="form.LastName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="form.Email" />
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" @onclick="Cancel">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Save
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    <div class="table-responsive">
        <table class="table table-hover table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Full name</th>
                    <th>Email</th>
                    <th>Enrolled</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in students)
                {
                    <tr>
                        <td class="text-center">@s.Id</td>
                        <td>@s.FullName</td>
                        <td>@s.Email</td>
                        <td>@s.EnrolledDate.ToString("dd.MM.yyyy")</td>
                        <td class="text-center">
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-sm btn-outline-warning"
                                        @onclick="() => StartEdit(s)">
                                    <i class="bi bi-pencil-square"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => Delete(s.Id)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                }

                @if (!students.Any())
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted fst-italic py-4">
                            No students found in the database!
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<StudentDto> students = new();
    private StudentFormModel form = new();
    private bool isFormVisible;
    private bool isLoading = true;
    private string? error;

    protected override async Task OnInitializedAsync() // this method is called when the component is initialized
        => await Load();

    private async Task Load()
    {
        try
        {
            isLoading = true;
            students = (await StudentService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartAdd()
    {
        form = new StudentFormModel();
        isFormVisible = true;
    }

    private void StartEdit(StudentDto dto)
    {
        form = new StudentFormModel
        {
            Id = dto.Id,
            Email = dto.Email,
            FirstName = dto.FullName.Split(' ')[0],
            LastName = dto.FullName.Split(' ').Skip(1).FirstOrDefault() ?? ""
        };
        isFormVisible = true;
    }

    private async Task Save()
    {
        try
        {
            if (form.Id == null)
            {
                await StudentService.AddAsync(form.ToCreateDto());
            }
            else
            {
                await StudentService.UpdateAsync(form.ToUpdateDto());
            }
            await Load();
            Cancel();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task Delete(int id)
    {
        await StudentService.DeleteAsync(id);
        await Load();
    }

    private void Cancel()
    {
        form = new StudentFormModel();
        isFormVisible = false;
    }

    private void ClearError() => error = null;
}