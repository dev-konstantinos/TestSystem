@page "/admin/students"
@using Microsoft.AspNetCore.Authorization
@using TestSystem.Entities.DTOs.Student
@using TestSystem.Entities.Interfaces
@attribute [Authorize(Roles = AppRoles.Admin)]

@inject IStudentService StudentService

<PageTitle>Students - Admin</PageTitle>

<h3 class="text-primary mb-4">Student Management</h3>

@if (isLoading)
{
    <p class="text-muted">Loading...</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger alert-dismissible fade show">
        @error
        <button type="button" class="btn-close" @onclick="ClearError"></button>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Full name</th>
                    <th>Email</th>
                    <th>Enrolled</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in students)
                {
                    <tr>
                        <td class="text-center">@s.Id</td>
                        <td>@($"{s.FirstName} {s.LastName}")</td>
                        <td>@s.Email</td>
                        <td>@s.EnrolledDate.ToString("dd.MM.yyyy")</td>
                    </tr>
                }

                @if (!students.Any())
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted fst-italic py-4">
                            No students found in the database
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<StudentDto> students = new();
    private bool isLoading = true;
    private string? error;

    protected override async Task OnInitializedAsync()
        => await Load();

    private async Task Load()
    {
        try
        {
            isLoading = true;
            students = (await StudentService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearError() => error = null;
}
